// ListsEditor.java: Class file for WO Component 'ListsEditor'

/*
 * Copyright (c) 2008, Gennady & Michael Kushnir
 * All rights reserved.
 * 
 * Redistribution and use in source and binary forms, with or without modification, are
 * permitted provided that the following conditions are met:
 * 
 * 	•	Redistributions of source code must retain the above copyright notice, this
 * 		list of conditions and the following disclaimer.
 * 	•	Redistributions in binary form must reproduce the above copyright notice,
 * 		this list of conditions and the following disclaimer in the documentation
 * 		and/or other materials provided with the distribution.
 * 	•	Neither the name of the RUJEL nor the names of its contributors may be used
 * 		to endorse or promote products derived from this software without specific 
 * 		prior written permission.
 * 		
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
 * SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
 * TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
 * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY
 * WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

package net.rujel.vselists;

import java.util.Enumeration;
import java.util.logging.Logger;

import net.rujel.base.MyUtility;
import net.rujel.interfaces.Person;
import net.rujel.interfaces.PersonLink;
import net.rujel.reusables.Counter;
import net.rujel.reusables.DegenerateFlags;
import net.rujel.reusables.NamedFlags;
import net.rujel.reusables.PlistReader;
import net.rujel.reusables.SessionedEditingContext;
import net.rujel.reusables.Various;
import net.rujel.reusables.WOLogLevel;

import com.webobjects.appserver.*;
import com.webobjects.eoaccess.EOUtilities;
import com.webobjects.eocontrol.*;
import com.webobjects.foundation.*;

// Generated by the WOLips Templateengine Plug-in at Aug 27, 2009 11:13:10 PM
public class ListsEditor extends com.webobjects.appserver.WOComponent {
	public static final Logger logger = Logger.getLogger("rujel.vselists");

	public static final NSArray sorter = new NSArray(new Object[] {
			new EOSortOrdering("delo",EOSortOrdering.CompareAscending),
			new EOSortOrdering("person",EOSortOrdering.CompareAscending)
	});

	public static Object init(Object obj, WOContext ctx) {
		if(obj == null || obj.equals("init")) {
			Person.Utility.delegateManager.addDelegate(new PersonDelegate(),30);
		} else if(obj.equals("regimes")) {
			if(ctx != null && ctx.hasSession())
				return ctx.session().valueForKeyPath(
					"strings.RujelVseLists_VseStrings.listRegime");
			return WOApplication.application().valueForKeyPath(
					"strings.RujelVseLists_VseStrings.listRegime");
		} else if(obj.equals("personInspector")) {
			return personInspector(ctx);
		}
		return null;
	}
	
	public EOEditingContext ec;
    public boolean showAll = false;
    public NSKeyValueCodingAdditions item;
    public NamedFlags access;
    public NSArray list;
	public Integer mode;
//	public NSMutableDictionary agregate;
	public NSArray categories;
	public Object selection;
	public Boolean cantAddClass;
	protected NSTimestamp date;
    
    public ListsEditor(WOContext context) {
        super(context);
    	ec = new SessionedEditingContext(context.session());
//        switchMode();
    }
    
    public void appendToResponse(WOResponse aResponse, WOContext aContext) {
    	NSTimestamp sesDate = (NSTimestamp)session().valueForKey("today");
    	if(!sesDate.equals(date)) {
    		date = sesDate;
    		switchMode();
    	}
    	super.appendToResponse(aResponse, aContext);
    }
    
    public void toggleAll() {
    	showAll = !showAll;
    	setSelection(selection);
    }
    
    public void switchMode() {
    	if(mode == null)
    		mode = new Integer(0);
    	selection = null;
    	list = NSArray.EmptyArray;
     	if(mode.intValue() > 0) {
//    		agregate = TeacherSelector.populate(ec, session());
//    		categories = (NSArray)agregate.removeObjectForKey("subjects");
    		categories = (NSArray)VseTeacher.agregatedList(ec, date);
        	access = (NamedFlags)session().valueForKeyPath("readAccess.FLAGS.VseTeacher");
        	cantAddClass = Boolean.FALSE;
    	} else {
//    		agregate = VseStudent.studentsAgregate(ec, date);
    		categories = VseStudent.agregatedList(ec, date);
        	access = (NamedFlags)session().valueForKeyPath("readAccess.FLAGS.VseStudent");
        	cantAddClass = (Boolean)session().valueForKeyPath(
        			"readAccess._create.VseEduGroup");
    	}
//		categories = (NSArray)agregate.removeObjectForKey("list");
    }
    
    public void setSelection(Object sel) {
    	if(sel == null) {
    		list = NSArray.EmptyArray;
    	} else if(sel instanceof VseEduGroup) {
    			setGroup((VseEduGroup)sel);
    	} else if(sel instanceof NSDictionary) {
        	selection = sel;
    		NSDictionary dict = (NSDictionary)sel;
        	boolean studMode = (mode == null || mode.intValue() == 0); 
    		list = (NSArray)dict.valueForKey("list");
    		if(list == null) {
    			EOQualifier qual = (EOQualifier)dict.valueForKey("qualifier");
    			String ent = (studMode)?VseStudent.ENTITY_NAME:VseTeacher.ENTITY_NAME;
    			EOFetchSpecification fs = new EOFetchSpecification(ent,qual,null);
    			list = ec.objectsWithFetchSpecification(fs);
    			if(list == null)
    				list = NSArray.EmptyArray;
    			if(list.count() > 0) {
    				if(studMode) {
    					list = EOQualifier.filteredArrayWithQualifier(list,
    							VseStudent.notInGroup);
    				}
    				dict.takeValueForKey(new Counter(list.count()), "allCount");
    			}
    		}
    		if(list != null && list.count() != 0) {
				if(!showAll) {
					NSArray args = new NSArray(new Object[] {date,date});
					EOQualifier qual = EOQualifier.qualifierWithQualifierFormat(
					   "(enter = nil OR enter <= %@) AND (leave = nil OR leave >= %@)", args);
					list = EOQualifier.filteredArrayWithQualifier(list,qual);
					dict.takeValueForKey(new Counter(list.count()), "currCount");
				}
				if(list.count() > 1)
					list = EOSortOrdering.sortedArrayUsingKeyOrderArray(list, sorter);
    		}
        	if(studMode)
        		access = (NamedFlags)session().valueForKeyPath("readAccess.FLAGS.VseStudent");
        	else
        		access = (NamedFlags)session().valueForKeyPath("readAccess.FLAGS.VseTeacher");
    	} else {
    		selection = null;
    		list = NSArray.EmptyArray;
    		Enumeration enu = categories.objectEnumerator();
    		while (enu.hasMoreElements()) {
				Object object = (Object) enu.nextElement();
				Object name = NSKeyValueCoding.Utility.valueForKey(object, "name");
				if(sel.toString().equals(name.toString())) {
					setSelection(object);
					break;
				}
			}
    	}
    }
    
    public VseEduGroup group() {
    	if(selection instanceof VseEduGroup)
    		return (VseEduGroup)selection;
    	else
    		return null;
    }

    public void setGroup(VseEduGroup gr) {
    	selection = gr;
    	access = (NamedFlags)session().valueForKeyPath("readAccess.FLAGS.VseList");
    	if(gr == null) {
    		list = null;
    	} else if(showAll) {
    		list = gr.lists();
    	} else {
    		list = gr.vseList();
    	}
    }
    
    public WOActionResults createGroup() {
    	WOComponent result = pageWithName("VseGroupInspector");
    	result.takeValueForKey(this, "returnPage");
    	result.takeValueForKey(ec, "ec");
    	return result;
    }
    
    public WOActionResults editGroup() {
    	WOComponent result = pageWithName("VseGroupInspector");
    	result.takeValueForKey(this, "returnPage");
    	result.takeValueForKey(selection, "currGroup");
    	return result;
    }
    
    public PersonLink plink() {
    	if(item == null)
    		return null;
    	if(item instanceof PersonLink)
    		return (PersonLink)item;
    	return (PersonLink)item.valueForKey("student");
    }
    
	public String rowClass() {
		if (showAll) {
			NSTimestamp enter = (NSTimestamp) item.valueForKey("enter");
			NSTimestamp leave = (NSTimestamp) item.valueForKey("leave");
			if (enter != null || leave != null) {
				NSTimestamp today = (NSTimestamp) session()
						.valueForKey("today");
				if (leave != null && leave.compare(today) < 0)
					return "grey";
				if (enter != null && enter.compare(today) > 0)
					return "grey";
			}
		}
		Boolean sex = (Boolean)valueForKeyPath("plink.person.sex");
		if(sex == null) return "gerade";
		return (sex.booleanValue())?"male":"female";
	}
	
	public WOActionResults editPerson() {
		WOComponent popup = pageWithName("PersonInspector");
		popup.takeValueForKey(this, "returnPage");
		popup.takeValueForKey(plink(), "personLink");
		popup.takeValueForKey("newPerson", "resultPath");
		return popup;
	}
	
	public WOActionResults addPerson() {
		WOComponent popup = pageWithName("SelectorPopup");
		popup.takeValueForKey(this, "returnPage");
		NSMutableDictionary dict = ((NSDictionary)session().valueForKeyPath(
		"strings.RujelVseLists_VseStrings.selectPerson")).mutableClone();
    	String ent = (mode == null || mode.intValue() == 0)?
    			VseStudent.ENTITY_NAME:VseTeacher.ENTITY_NAME; 
		dict.takeValueForKeyPath(ent, "presenterBindings.entity");
		popup.takeValueForKey(dict, "dict");
		popup.takeValueForKey("newPerson", "resultPath");
		return popup;
	}
	
	public void setNewPerson(PersonLink person) {
		boolean student = (mode == null || mode.intValue() == 0);
		if(student && selection == null)
			return;
		if(person == null) {
			ec.revert();
			return;
		}
		person = (PersonLink)EOUtilities.localInstanceOfObject(ec, (EOEnterpriseObject)person);
		if (group() != null) {
			Enumeration enu = group().vseList().objectEnumerator();
			while (enu.hasMoreElements()) {
				EOEnterpriseObject vl = (EOEnterpriseObject) enu.nextElement();
				if (vl.valueForKeyPath("student.person") == person.person()) {
//					session().takeValueForKey(session().valueForKeyPath(
//						"strings.RujelVseLists_VseStrings.duplicateEntry"),"message");
					return;
				}
			}
		}
		ec.lock();
		try {
			if (student) {
				if(!(person instanceof VseStudent))
					person = VseStudent.studentForPerson(person.person(), date, true);
				VseStudent aStudent = (VseStudent)person;
				if (selection instanceof VseEduGroup) {
					aStudent.setAbsGrade(group().absStart());
					EOEnterpriseObject newEntry = EOUtilities
							.createAndInsertInstance(ec, "VseList");
					newEntry.addObjectToBothSidesOfRelationshipWithKey(group(),
							"eduGroup");
					newEntry.addObjectToBothSidesOfRelationshipWithKey(
							aStudent, "student");
					newEntry.takeValueForKey(date, "enter");
					logger.log(WOLogLevel.UNOWNED_EDITING, "Added person to group",
							new Object[] {session(),person,selection});
				} else {
					Integer grade = aStudent.absGrade();
					if(grade == null || grade.intValue() <= 0) {
						grade = (Integer)NSKeyValueCoding.Utility.valueForKey(
								selection, "absGrade");
						if(grade.intValue() < 1000) {
							Integer year = MyUtility.eduYearForDate(date);
							grade = new Integer(year.intValue() - grade.intValue());
						}
						aStudent.setAbsGrade(grade);
					}
					if(aStudent.enter() == null)
						aStudent.setEnter(date);
				}
			} else {
				if(!(person instanceof VseTeacher))
					person = VseTeacher.teacherForPerson(person.person(), date, true);
			}
			ec.saveChanges();
//			if(!list.containsObject(person)) {
				if(student) {
					if(person instanceof VseStudent) {
						Object sel = selection;
						setSelection(((VseStudent)person).absGrade());
						setSelection(sel);
					}
//					list = list.arrayByAddingObject(person);
				} else {
					categories = (NSArray)VseTeacher.agregatedList(ec, date);
					setSelection(person.person().lastName().substring(0,1));
//				}
			}
		} catch (RuntimeException e) {
			logger.log(WOLogLevel.WARNING, "Error adding person to group",
					new Object[] {session(),person,selection,e});
			session().takeValueForKey(e.getMessage(), "message");
			ec.revert();
		} finally {
			ec.unlock();
		}
	}
	
	public void save() {
		ec.lock();
		try {
			ec.saveChanges();
			logger.log(WOLogLevel.UNOWNED_EDITING, "Changed enter/leave dates",
					new Object[] {session(),selection});
		} catch (Exception e) {
			logger.log(WOLogLevel.WARNING, "Error saving enter/leave dates changes",
					new Object[] {session(),selection,e});
			session().takeValueForKey(e.getMessage(), "message");
			ec.revert();
		} finally {
			ec.unlock();
		}
	}
	
	public Boolean hideAddButton() {
		if(mode == null || mode.intValue() == 0) {
			if(selection == null)
				return Boolean.TRUE;
			if(selection instanceof VseEduGroup)
				return (Boolean)session().valueForKeyPath("readAccess._create.VseList");
			return (Boolean)session().valueForKeyPath("readAccess._create.VseStudent");
		} else {
			return (Boolean)session().valueForKeyPath("readAccess._create.VseTeacher");
		}
	}

	public static Object personInspector(WOContext ctx) {
		WOSession ses = ctx.session();
		EOEnterpriseObject person = (EOEnterpriseObject)ses.objectForKey("PersonInspector");
		if(person == null)
			return null;
		NSMutableArray result = new NSMutableArray();
		EOEditingContext ec = person.editingContext();
		NamedFlags access = DegenerateFlags.ALL_FALSE;
		boolean created = ec.globalIDForObject(person).isTemporary();
		if(created) {
			try {
				Person pers = (Person)person.valueForKey(VseTeacher.PERSON_KEY);
				if(pers != null && ec.globalIDForObject(pers).isTemporary()) {
					access = (NamedFlags)ses.valueForKeyPath(
							"readAccess.FLAGS." + pers.entityName());
				}
			} catch(Exception e) {
				
			}
		} else {
			access = (NamedFlags)ses.valueForKeyPath(
			"readAccess.FLAGS." + person.entityName());
		}
		if(access.getFlag(0)) {
			NSDictionary dict = (NSDictionary)ses.valueForKeyPath(
					"strings.RujelVseLists_VseStrings.inspectors.Person");
			dict = PlistReader.cloneDictionary(dict, true);
			if(created)
				dict.takeValueForKey(person.valueForKey(VseTeacher.PERSON_KEY), "usage");
			else
				dict.takeValueForKey(person, "usage");
			dict.takeValueForKey(access, "access");
			result.addObject(dict);
		}
		access = (NamedFlags)ses.valueForKeyPath("readAccess.FLAGS.VseStudent");
		NSArray list = null;
		if(access.getFlag(0)) {
			if(created) {
					list = null;
			} else { 
				list = EOUtilities.objectsMatchingKeyAndValue(ec,
						VseStudent.ENTITY_NAME, VseStudent.PERSON_KEY, person);
			}
			if((person instanceof VseStudent) || (list != null && list.count() > 0)) {
				NSDictionary dict = (NSDictionary)ses.valueForKeyPath(
						"strings.RujelVseLists_VseStrings.inspectors.Student");
				dict = PlistReader.cloneDictionary(dict, true);
				dict.takeValueForKey(access, "access");
				if(created)
					dict.takeValueForKey(person, "usage");
				else
					dict.takeValueForKey(list, "usage");
				result.addObject(dict);
			}
		}
		access = (NamedFlags)ses.valueForKeyPath("readAccess.FLAGS.VseTeacher");
		if(access.getFlag(0)) { 
			if(created) {
				list = null;
			} else { 
				list = EOUtilities.objectsMatchingKeyAndValue(ec,
						VseTeacher.ENTITY_NAME, VseTeacher.PERSON_KEY, person);
			}
			if((person instanceof VseTeacher) || (list != null && list.count() > 0)) {
				NSDictionary dict = (NSDictionary)ses.valueForKeyPath(
						"strings.RujelVseLists_VseStrings.inspectors.Teacher");
				dict = PlistReader.cloneDictionary(dict, true);
				if(created)
					dict.takeValueForKey(person, "usage");
				else
					dict.takeValueForKey(list, "usage");
				dict.takeValueForKey(access, "access");
				result.addObject(dict);
			}
		}
		if(result.count() == 0)
			return null;
		return result;
	}
	
	public void select() {
		setSelection(item);
	}
/*
	public Object hideRow() {
		if(showAll)
			return Boolean.FALSE;
		if (item instanceof NSDictionary) {
			return NSKeyValueCoding.Utility.valueForKey(item, "hide");
		}
		return Boolean.FALSE;
	}*/

	public String listClass() {
		if(selection == item)
			return "selection";
		if(item instanceof EOEnterpriseObject)
			return "ungerade";
		Object count = item.valueForKey("currCount"); //(showAll)?"allCount":
		if(Various.boolForObject(count))
			return "orange";
		else
			return "grey";
	}
	
	public Number count() {
		if(item instanceof EOEnterpriseObject) {
			if(showAll)
				return (Number)item.valueForKeyPath("lists.count");
			else
				return (Number)item.valueForKey("count");
		}
		return (Number)item.valueForKey((showAll)?"allCount":"currCount");
	}
}