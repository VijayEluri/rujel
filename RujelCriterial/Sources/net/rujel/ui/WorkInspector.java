// WorkInspector.java

/*
 * Copyright (c) 2008, Gennady & Michael Kushnir
 * All rights reserved.
 * 
 * Redistribution and use in source and binary forms, with or without modification, are
 * permitted provided that the following conditions are met:
 * 
 * 	•	Redistributions of source code must retain the above copyright notice, this
 * 		list of conditions and the following disclaimer.
 * 	•	Redistributions in binary form must reproduce the above copyright notice,
 * 		this list of conditions and the following disclaimer in the documentation
 * 		and/or other materials provided with the distribution.
 * 	•	Neither the name of the RUJEL nor the names of its contributors may be used
 * 		to endorse or promote products derived from this software without specific 
 * 		prior written permission.
 * 		
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
 * SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
 * TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
 * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY
 * WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

package net.rujel.ui;

import java.util.logging.Logger;

import net.rujel.base.SettingsBase;
import net.rujel.criterial.*;
import net.rujel.reusables.ModulesInitialiser;
import net.rujel.reusables.WOLogLevel;

import com.webobjects.appserver.*;
import com.webobjects.eoaccess.EOUtilities;
import com.webobjects.eocontrol.*;
import com.webobjects.foundation.*;

// Generated by the WOLips Templateengine Plug-in at Aug 28, 2008 8:22:47 PM
public class WorkInspector extends com.webobjects.appserver.WOComponent {

	public WOComponent returnPage;
	public Work work;
	public NSArray types;
	public Object item;
	
	public Integer hours;
	public Integer minutes;
	
	public EOEditingContext tmpEC;

    public WorkInspector(WOContext context) {
        super(context);
    }
    
    public void setWork(Work newWork) {
    	work = newWork;
    	if(work.load() != null) {
    		int mins = work.load().intValue();
    		int hrs = mins / 60;
    		mins = mins % 60;
    		if(mins > 0)
    			minutes = new Integer(mins);
    		if(hrs > 0)
    			hours = new Integer(hrs);
    	}
    	EOQualifier qual = new EOKeyValueQualifier("dfltFlags",
    			EOQualifier.QualifierOperatorLessThan,new Integer(64));
    	EOFetchSpecification fs = new EOFetchSpecification("WorkType",qual,
    			ModulesInitialiser.sorter);
    	types = newWork.editingContext().objectsWithFetchSpecification(fs);
    }

    public String lessonTitle() {
    	return NotePresenter.titleForLesson(work);
    }
        
    public WOActionResults save() {
    	int load = 0;
    	if(hours != null)
    		load = hours.intValue() * 60;
    	if(minutes != null)
    		load = load + minutes;
    	if(work.load() == null || work.load().intValue() != load)
    		work.setLoad(new Integer(load));
    	WORequest req = context().request();
    	NSNumberFormatter frmt = new NSNumberFormatter("0");
    	Number critCount = req.numericFormValueForKey("critCount", frmt);
    	EOEditingContext ec = work.editingContext();
    	for (int i = 0; i <= critCount.intValue(); i++) {
    		Integer criterion = new Integer(i);
			EOEnterpriseObject mask = work.getCriterMask(criterion);
			Number val = req.numericFormValueForKey("m" + i, frmt);
			if(val != null && !(val instanceof Integer))
				val = new Integer(val.intValue());
			if(val == null) {
				if(mask != null) {
					work.removeObjectFromBothSidesOfRelationshipWithKey
								(mask,Work.CRITER_MASK_KEY);
					ec.deleteObject(mask);
				}
				continue;
			} else {
				if(mask == null) {
					mask = EOUtilities.createAndInsertInstance(ec, "CriterMask");
					work.addObjectToBothSidesOfRelationshipWithKey(
							mask, Work.CRITER_MASK_KEY);
					mask.takeValueForKey(criterion, "criterion");
				}
				if(!val.equals(mask.valueForKey("max")))
					mask.takeValueForKey(val, "max");
			}
			if(mask != null) {
				val = req.numericFormValueForKey("w" + i, frmt);
				Number mWeight = (Number)mask.valueForKey("weight");
				if(mWeight == null || val == null || mWeight.intValue() != val.intValue())
					mask.takeValueForKey(val, "weight");
			}
		}
    	returnPage.ensureAwakeInContext(context());
    	WOActionResults result = null;
    	try {
    		if(work.workType() == null) {
    			work.setWorkType((EOEnterpriseObject)types.objectAtIndex(0));
    			Logger.getLogger("rujel.criterial").log(WOLogLevel.WARNING,
    					"Autosetting workType",new Object[] {session(),work});
    		}
    		if(tmpEC != null) {
//    			tmpEC.lock();
    			tmpEC.saveChanges();
        		/*if(shouldNullify)
        			work.nullify();
    			EOEditingContext ec = (EOEditingContext)returnPage.valueForKey("ec");
    			work = (Work)EOUtilities.localInstanceOfObject(ec, work);*/
    			returnPage.takeValueForKey(work, "currLesson");
    			returnPage.takeValueForKeyPath("MarksPresenter", "present.tmpPresenter");
    		}
    		if(shouldNullify)
    			work.nullify();
    		result = (WOActionResults)returnPage.valueForKey("saveNoreset");
    	} catch (NSKeyValueCoding.UnknownKeyException e) {
    		session().takeValueForKey(application().valueForKeyPath
    				("strings.RujelCriterial_Strings.messages.notSaved"), "message");
    	} catch (Exception e) {
    		session().takeValueForKey(e.getMessage(), "message");
/*    	} finally {
    		if(tmpEC != null)
    			tmpEC.unlock();
    		//ec.unlock();    	*/	
    	}
    	if(result == null)
    		result = returnPage;
		session().removeObjectForKey("lessonProperies");
    	return result;
    }

/*	private NSArray _criteria;
    public NSArray criteria() {
		if(_criteria == null) {
			_criteria = CriteriaSet.criteriaForCourse(work.course());
			if(_criteria == null)
				_criteria = NSArray.EmptyArray;
		}
		return _criteria;
    }
*/
    public int critIdx = -1;

    public Integer critCount() {
    	Integer count = (Integer)work.valueForKeyPath("critSet.criteria.@max.criterion");
    	if (count != null && count.intValue() > 0)
    		return count;
    	NSArray mask = work.criterMask();
    	if(mask == null || mask.count() == 0)
    		return new Integer(1);
    	count = (Integer)mask.valueForKeyPath("@max.criterion");
    	return new Integer (count.intValue() + 1);
    }
    
    protected Integer criterion() {
    	return new Integer(critIdx + 1);
    }
    
    public String critName() {
    	return work.criterName(criterion());
    }
    
    public EOEnterpriseObject critItem() {
    	if(critIdx < 0)
    		return null;
    	CriteriaSet set = work.critSet();
    	if(set == null)
    		return null;
    	return set.criterionForNum(criterion());
    }
    
    protected String fieldName(char prefix) {
//    	if(critIdx < 0)
//    		return null;
    	StringBuilder buf = new StringBuilder(3);
    	buf.append(prefix).append(critIdx + 1);
    	return buf.toString();
    }
    
    public String maxName() {
    	return fieldName('m');
    }
    
    public String weightName() {
    	return fieldName('w');
    }
    
    public String onChange() {
    	if(critIdx < 0)
    		return "return isNumberInput(event);";
    	if(work.critSet() != null)
    		return "return isNumberInput(event);";
    	Integer count = (Integer)work.valueForKeyPath("criterMask.@max.criterion");
    	if(count != null && critIdx < count.intValue())
    		return "return isNumberInput(event);";
    	return "return addCriterion(event);";
    }
    
    public String onClick() {
    	Object crit = criterMax();
    	if(critIdx >= 0 && crit == null)
    		crit = valueForKeyPath("critItem.dfltMax");
    	if(crit == null && critIdx < 0)
    		crit = SettingsBase.stringSettingForCourse(CriteriaSet.ENTITY_NAME,
    				work.course(), work.editingContext());
    	if(crit == null)
        	return "select();";
    	StringBuilder buf = new StringBuilder("if(!value){value=(");
    	buf.append(crit).append(");blockCriters(event);}select();");
    	return buf.toString();
    }

    protected EOEnterpriseObject itemMask() {
    	if(work == null)
    		return null;
//    	if(critIdx < 0)
//    		return null;
    	return work.getCriterMask(criterion());
    }
	
    public Number criterMax() {
    	EOEnterpriseObject _itemMask = itemMask();
        if(_itemMask == null) return null;
		return (Number)_itemMask.valueForKey("max");
    }
    
    private boolean shouldNullify = false;
 /*   public void setCriterMax(Number newCriterMax) {
		boolean weightToMax = SettingsReader.boolForKeyPath("edu.weightToMax",true);
		EOEnterpriseObject _itemMask = itemMask();
        if(_itemMask == null) { // create new criterMask
			if(newCriterMax == null) return;
			_itemMask = EOUtilities.createAndInsertInstance(work.editingContext(),"CriterMask");
			work.addObjectToBothSidesOfRelationshipWithKey(_itemMask,"criterMask");
			_itemMask.takeValueForKey(critItem,"criterion");
			if(weightToMax)
				_itemMask.takeValueForKey(newCriterMax,"weight");
			else
				_itemMask.takeValueForKey(new Integer(1),"weight");
			
			_itemMask.takeValueForKey(newCriterMax,"max");
			shouldNullify = true;
		} else if(newCriterMax == null) { // remove criter max
			work.removeObjectFromBothSidesOfRelationshipWithKey(_itemMask,"criterMask");
			_itemMask = null;
			shouldNullify = true;
			return;
		} else if(newCriterMax.intValue() != criterMax().intValue()){  // update criter max
			Object oldWeight = _itemMask.valueForKey("weight");
			Object oldMax = _itemMask.valueForKey("max");
			if(weightToMax && (oldWeight == null || oldMax == null || oldWeight.equals(oldMax)))
				_itemMask.takeValueForKey(newCriterMax,"weight");
			_itemMask.takeValueForKey(newCriterMax,"max");
		}
    }*/

    public Number criterWeight() {
    	EOEnterpriseObject _itemMask = itemMask();
    	if(_itemMask == null) return null;
    	return (Number)_itemMask.valueForKey("weight");
    }
    
/*    public void setCriterWeight(Number newCriterWeight) {
    	EOEnterpriseObject _itemMask = itemMask();
    	if(_itemMask == null || newCriterWeight == null) {
    		return;
    	}
    	if(newCriterWeight.intValue() != criterWeight().intValue())
    		_itemMask.takeValueForKey(newCriterWeight,"weight");
    }*/

}