package net.rujel.eduresults;

import java.util.Enumeration;
import java.util.logging.Logger;

import net.rujel.base.MyUtility;
import net.rujel.base.SettingsBase;
import net.rujel.reusables.ModulesInitialiser;
import net.rujel.reusables.PlistReader;
import net.rujel.reusables.WOLogLevel;

import com.webobjects.appserver.*;
import com.webobjects.eoaccess.EOUtilities;
import com.webobjects.eocontrol.EOAndQualifier;
import com.webobjects.eocontrol.EOEditingContext;
import com.webobjects.eocontrol.EOEnterpriseObject;
import com.webobjects.eocontrol.EOFetchSpecification;
import com.webobjects.eocontrol.EOKeyValueQualifier;
import com.webobjects.eocontrol.EOQualifier;
import com.webobjects.foundation.NSArray;
import com.webobjects.foundation.NSDictionary;
import com.webobjects.foundation.NSMutableArray;

// Generated by the WOLips Templateengine Plug-in at Sep 3, 2009 12:37:59 PM
public class SetupItogs extends com.webobjects.appserver.WOComponent {
	protected static Logger logger = Logger.getLogger("rujel.itog");

 	public EOEditingContext ec;
	public String listName;
	public NSArray extraLists;
	public NSArray allTypes;
	public NSMutableArray activeTypes = new NSMutableArray();
	public Object item;
	public ItogType currType;
	public NSArray itogsList;

	public SetupItogs(WOContext context) {
        super(context);
        setEc((EOEditingContext)context.page().valueForKey("ec"));
		context().page().takeValueForKey(this, "toReset");
    }

	public void setEc(EOEditingContext newEc) {
		ec = newEc;
		ec.lock();
		try {
			EOFetchSpecification fs = new EOFetchSpecification(ItogType.ENTITY_NAME,
					null, ModulesInitialiser.sorter);
			allTypes = ec.objectsWithFetchSpecification(fs);
			SettingsBase base = SettingsBase.baseForKey(ItogMark.ENTITY_NAME, ec, true);
			setListName(base.textValue());
			if(listName == null) {
				setListName((String)application().valueForKeyPath(
					"strings.RujelEduPlan_EduPlan.SetupPeriods.defaultListName"));
				base.setTextValue(listName);
				ec.saveChanges();
				logger.log(WOLogLevel.SETTINGS_EDITING,
						"Created default ItogMark ListName setting: " + listName,
						new Object[] {session(), base});
			} else {
				EOQualifier qual = new EOKeyValueQualifier("listName",
						EOQualifier.QualifierOperatorNotEqual,listName);
				fs = new EOFetchSpecification("ItogTypeList",qual,null);
				extraLists = ec.objectsWithFetchSpecification(fs);
			}
		} catch (Exception e) {
			logger.log(WOLogLevel.WARNING,
					"Error creating default ItogMark ListName setting",
					new Object[] {session(), e});
		} finally {
			ec.unlock();
		}
	}
	
	public void setListName(String name) {
		listName = name;
		if(listName != null) {
			NSArray used = EOUtilities.objectsMatchingKeyAndValue(ec, 
					"ItogTypeList", "listName", listName);
			if(used == null || used.count() == 0)
				activeTypes.removeAllObjects();
			else
				activeTypes.setArray((NSArray)used.valueForKey("itogType"));
		}
		currType = null;
		itogsList = null;
	}
	
	public boolean active() {
		return activeTypes.containsObject(item);
	}
	
	public void setActive(boolean set) {
		if(set) {
			if(!active())
				activeTypes.addObject(item);
		} else {
			activeTypes.removeObject(item);
		}
	}
	
	public WOActionResults saveList() {
		ec.lock();
		try {
			NSArray previous = EOUtilities.objectsMatchingKeyAndValue(ec, 
					"ItogTypeList", "listName", listName);
			NSMutableArray toDelete = (previous==null || previous.count() == 0)?
					new NSMutableArray() : previous.mutableClone();
			NSMutableArray toAdd = activeTypes.mutableClone();
			Enumeration enu = previous.objectEnumerator();
			while (enu.hasMoreElements()) {
				EOEnterpriseObject tl = (EOEnterpriseObject) enu.nextElement();
				ItogType it = (ItogType)tl.valueForKey("itogType");
				if(toAdd.removeObject(it)) {
					toDelete.removeObject(tl);
				}
			}
			if(toAdd.count() > 0) {
				enu = toAdd.objectEnumerator();
				while (enu.hasMoreElements()) {
					ItogType it = (ItogType) enu.nextElement();
					EOEnterpriseObject tl = (EOEnterpriseObject)toDelete.removeLastObject();
					if(tl == null) {
						tl = EOUtilities.createAndInsertInstance(ec, "ItogTypeList");
						tl.takeValueForKey(listName, "listName");
					}
					tl.addObjectToBothSidesOfRelationshipWithKey(it, "itogType");
				}
			}
			if(toDelete.count() > 0) {
				enu = toDelete.objectEnumerator();
				while (enu.hasMoreElements()) {
					EOEnterpriseObject tl = (EOEnterpriseObject) enu.nextElement();
					ec.deleteObject(tl);
				}
			}
			ec.saveChanges();
		} catch (Exception e) {
			logger.log(WOLogLevel.WARNING,"Error saving changes in list " + listName,e);
			session().takeValueForKey(e.getMessage(), "message");
			ec.revert();
			setListName(listName);
		} finally {
			ec.unlock();
		}
		return null;
	}
	
	public WOActionResults selectType() {
		setCurrType((ItogType)item);
		return null;
	}
	
	public void setCurrType(ItogType type) {
		currType = type;
		ec.lock();
		try {
		if(allTypes.containsObject(type)) {
			EOQualifier[] quals = new EOQualifier[2];
			quals[0] = new EOKeyValueQualifier(ItogContainer.ITOG_TYPE_KEY,
					EOQualifier.QualifierOperatorEqual,currType);
			quals[1] = new EOKeyValueQualifier(ItogContainer.EDU_YEAR_KEY,
					EOQualifier.QualifierOperatorEqual,session().valueForKey("eduYear"));
			quals[0] = new EOAndQualifier(new NSArray(quals));
			EOFetchSpecification fs = new EOFetchSpecification(ItogContainer.ENTITY_NAME,
					quals[0], MyUtility.numSorter);
			itogsList = ec.objectsWithFetchSpecification(fs);
		} else {
			allTypes = allTypes.arrayByAddingObject(type);
			itogsList = NSArray.EmptyArray;
			EOEnterpriseObject tl = EOUtilities.createAndInsertInstance(ec, "ItogTypeList");
			tl.takeValueForKey(listName, "listName");
			tl.addObjectToBothSidesOfRelationshipWithKey(type, "itogType");
			activeTypes.addObject(type);
			ec.saveChanges();
		}
		}catch (Exception e) {
			// TODO: handle exception
		} finally {
			ec.unlock();
		}
//		itogName = currType.name();
//		itogTitle = currType.title();
//		itogCount = currType.inYearCount();
	}
	
	public WOActionResults addType() {
		WOComponent selector = pageWithName("SelectorPopup");
		selector.takeValueForKey(context().page(), "returnPage");
		selector.takeValueForKey("currType", "resultPath");
		selector.takeValueForKey(this, "resultGetter");
		NSDictionary dict = (NSDictionary)application().valueForKeyPath(
				"strings.RujelEduResults_EduResults.addType");
		dict = PlistReader.cloneDictionary(dict, true);
		dict.takeValueForKeyPath(ec, "presenterBindings.ec");
		dict.takeValueForKeyPath(valueForKeyPath("allTypes.@max.sort"),
				"presenterBindings.maxSort");
		selector.takeValueForKey(dict, "dict");
		return selector;
	}
	
	public boolean synchronizesVariablesWithBindings() {
        return false;
	}
	
	public void reset() {
		super.reset();
		currType = null;
		itogsList = null;
        activeTypes.removeAllObjects();
        setEc((EOEditingContext)context().page().valueForKey("ec"));
	}
}