package net.rujel.stats;

import java.lang.reflect.Method;
import java.util.Enumeration;

import net.rujel.interfaces.EduCourse;
import net.rujel.reusables.DisplayAny;
import net.rujel.reusables.Various;

import com.webobjects.appserver.*;
import com.webobjects.eocontrol.EOEditingContext;
import com.webobjects.eocontrol.EOEnterpriseObject;
import com.webobjects.foundation.*;

// Generated by the WOLips Templateengine Plug-in at Jun 1, 2009 1:13:34 PM
public class StatsPlugin extends com.webobjects.appserver.WOComponent {
	
	public EduCourse course;
	public NSMutableArray rows;
	public Object item;
	public int cols =1;
	public Integer index;
	
    public StatsPlugin(WOContext context) {
        super(context);
    }
    
//	public void appendToResponse(WOResponse aResponse, WOContext aContext) {
    public void setCourse(EduCourse aCourse) {
    	course = aCourse;
		NSKeyValueCodingAdditions readAccess = (NSKeyValueCodingAdditions)
			session().valueForKey("readAccess");
		NSArray reports = (NSArray)session().valueForKeyPath("modules.statCourseReport");
		if(reports == null || reports.count() == 0)
			return;
		EOEditingContext ec = course.editingContext();
		Enumeration enu = reports.objectEnumerator();
		rows = new NSMutableArray();
		NSArray currKeys = null;
		cols = 0;
		Object currDesc = null;
		NSArray formulas = null;
		while (enu.hasMoreElements()) {
			NSDictionary cfg = (NSDictionary) enu.nextElement();
			String entName = (String)cfg.valueForKey("entName");
			if(Various.boolForObject(readAccess.valueForKeyPath("_read." + entName)))
				continue;
			String statField = (String)cfg.valueForKey("statField");
			EOEnterpriseObject param1 = (EOEnterpriseObject)cfg.valueForKey("param1");
			EOEnterpriseObject param2 =(EOEnterpriseObject) cfg.valueForKey("param2");
			if(param2 == null && param1 != null) {
				param2 = course;
			}
			if(param1 == null) {
				param1 = course;
			}
			boolean create = (Boolean)readAccess.valueForKeyPath("create.Stats");
			NSDictionary dict = null;
			Grouping grouping = Description.getGrouping(entName, 
					statField, param1, param2,create);
			Object desc = null;
			if((grouping == null || ec.globalIDForObject(grouping).isTemporary())) {
				Method ifEmpty = (Method)cfg.valueForKey("ifEmpty");
				if(ifEmpty != null);
				dict = StatsModule._execIfEmpty(ifEmpty, grouping, create, 
						param1, param2, ec, entName, statField);
				desc = Description.getDescription(entName, statField, 
						entForParam(param1), entForParam(param2), ec, create);
				if(desc == null) {
					desc = entName + "_" + statField;
				} else if (((Description)desc).description() == null) {
					NSKeyValueCoding.Utility.takeValueForKey(desc, cfg.valueForKey(
							Description.DESCRIPTION_KEY), Description.DESCRIPTION_KEY);
					try {
						ec.saveChanges();
					} catch (Exception e) {
						ec.revert();
					}
				}
			} else {
				dict = grouping.dict();
				desc = grouping.description();
			}
			if(!desc.equals(currDesc)) {
				currDesc = desc;
				NSArray keys = (NSArray)cfg.valueForKey("keys");
				if(keys == null && (desc instanceof Description))
					keys = (NSArray)NSKeyValueCodingAdditions.Utility.
										valueForKeyPath(desc, "borderSet.sortedTitles");
				if(keys == null)
					keys = new NSArray("");
				if(!keys.contains(""))
					keys = keys.arrayByAddingObject("");
				currKeys = keys;
				
				NSMutableDictionary rowDict = new NSMutableDictionary("grey","styleClass");
				rowDict.takeValueForKey("font-weight:bold;", "style");
				if(desc instanceof Description) {
					rowDict.takeValueForKey(((Description)desc).description(), "title");
				} else {
					Object title = cfg.valueForKey(Description.DESCRIPTION_KEY);
					rowDict.takeValueForKey((title!=null)?title:entName, "title");
				}
				rowDict.takeValueForKey(application().valueForKeyPath(
						"strings.RujelStats_Stats.total"), "total");

				Object tmp = cfg.valueForKey("addCalculations");
				if(Various.boolForObject(tmp)) {
					formulas = Calculations.allFormulas();
				} else {
					formulas = null;
				}
				tmp = cfg.valueForKey("formula");
				if(tmp != null) {
					if(formulas == null) formulas = new NSArray(tmp);
					else formulas = formulas.arrayByAddingObject(tmp);
				}
				tmp = cfg.valueForKey("formulas");
				if(tmp != null) {
					if(formulas == null) formulas = (NSArray)tmp;
					else formulas = formulas.arrayByAddingObjectsFromArray((NSArray)tmp);
				}

				if(formulas != null)
					currKeys = currKeys.arrayByAddingObjectsFromArray(formulas);
				if(currKeys.count() > cols)
					cols = currKeys.count() +2;
				rowDict.takeValueForKey(currKeys.objects(),"values");
				rows.addObject(rowDict);
			}
			NSMutableDictionary rowDict = new NSMutableDictionary("gerade","styleClass");
			rowDict.takeValueForKey(cfg.valueForKey("title"), "title");
			Object[] row = new Object[currKeys.count()];
			if(grouping != null) {
				rowDict.takeValueForKey(grouping.total(), "total");
			}
			Enumeration kEnu = dict.keyEnumerator();
			while (kEnu.hasMoreElements()) {
				Object key = kEnu.nextElement();
				if(key.equals("keys") && (dict.objectForKey(key) instanceof NSArray))
					continue;
				int idx = currKeys.indexOf(key);
				if(idx >= 0) {
//					rowDict.setObjectForKey(dict.objectForKey(key), key);
					row[idx] = dict.objectForKey(key);
					continue;
				}
				if(key.equals("total")) {
					Number total = (Number)dict.objectForKey("total");
					if(grouping == null) {
						rowDict.takeValueForKey(total, "total");
						continue;
					} else if(total.equals(grouping.total())) {
						continue;
					}
				}
				StringBuffer others = (StringBuffer)rowDict.objectForKey("others");
					//row[keys.count() + 2];
				if(others == null) {
					others = new StringBuffer();
//					row[keys.count() + 1] = others;
					rowDict.setObjectForKey(others, "others");
					if(cols < row.length + 3)
						cols = row.length + 3;
				} else {
					others.append(" ; ");
				}
				others.append('\'').append(key).append('\'');
				others.append(':').append(dict.objectForKey(key));
			} // process keys
			if(formulas != null && formulas.count() > 0) {
				int idx = row.length - formulas.count();
				kEnu = formulas.objectEnumerator();
				NSNumberFormatter format = new NSNumberFormatter();
				while (kEnu.hasMoreElements()) {
					NSDictionary fla = (NSDictionary) kEnu.nextElement();
					Object val = DisplayAny.ValueReader.evaluateValue(
							fla.valueForKey("value"), dict, this);
					if(val != null) {
						String pattern = (String)fla.valueForKeyPath(
						"presenterBindings.numberformat");
						if(pattern != null)
							format.setPattern(pattern);
						else
							format.setPattern(NSNumberFormatter.DefaultPattern);
						row[idx] = format.format(val);
					}
					idx++;
				}
			}
			rowDict.takeValueForKey(row, "values");
//			rowDict.takeValueForKey(new Integer(row.length), "valuesCount");
			rows.addObject(rowDict);
		} // process reports
	}
    
	private static String entForParam(Object param) {
		if(param == null)
			return EduCourse.entityName;
		if(param instanceof EOEnterpriseObject)
			return ((EOEnterpriseObject)param).entityName();
		return param.toString();
	}
	
    public boolean titleRow() {
    	return ("grey".equals(((NSDictionary)item).valueForKey("styleClass")));
    }
    
    public int count() {
//    	if(titleRow()) {
//    		return ((NSArray)item).count();
//    	} else 
    	if(item instanceof NSDictionary) {
			Object[] row = (Object[])((NSDictionary)item).valueForKey("values");
			return row.length;
		}
    	return 0;
    }
    
    public String lastCell() {
    	int num = 2 + count();
    	boolean titleRow = titleRow();
    	if(num >= cols)
    		return null;
    	StringBuilder buf = new StringBuilder(12);
    		buf.append((titleRow)?"<th":"<td");
    	if(cols > num +1)
    		buf.append(" align = \"left\" colspan = \"").append(cols - num).append('"');
//    	if(titleRow)
//    		buf.append(" style = \"");
    	buf.append('>');
    	if(titleRow) {
    		buf.append(application().valueForKeyPath("strings.RujelStats_Stats.others"));
    	} else {
    		Object val = ((NSDictionary)item).valueForKey("others");
    		if(val != null)
    			buf.append(val);
    	}
    	buf.append((titleRow)?"</th>":"</td>");
    	return buf.toString();
    }
	
	public String value() {
		if(item == null || index == null)
			return null;
		int idx = index.intValue();
		if(item instanceof NSDictionary) {
			Object[] row = (Object[])((NSDictionary)item).valueForKey("values");
			if(idx >= row.length)
				return null;
			if(row[idx] == null)
				return "<td></td>";
			if(!titleRow())
				return "<td>" + row[idx].toString() + "</td>";
			StringBuilder result = new StringBuilder("<th style = \"");
			String val = null;
			String title = null;
			boolean quote = false;
			if(row[idx] instanceof NSDictionary) {
				NSDictionary dict = (NSDictionary)row[idx];
				title = (String)dict.valueForKey("title");
				val = (String)dict.valueForKey("short");
				if(val == null) {
					val = title;
					title = null;
				}
				quote = (val.length() < 3);
			} else {
				val = row[idx].toString();
				quote = (val.length() < 3);
				val = WOMessage.stringByEscapingHTMLString(val.toString());
			}
			if(quote) {
				result.append("min-width:1.6em;\"");
			} else {
				result.append("white-space:nowrap;\"");
			}
			if(val.equals("")) {
				title = (String)application().valueForKeyPath("strings.RujelStats_Stats.none");
				val = "&oslash;";
				quote = false;
			} else if(row[idx] instanceof NSDictionary) {
				quote = false;
			}
			if(title != null)
				result.append(" title = \"").append(title).append('"');
			result.append('>');
			if(quote) result.append('\'');
			result.append(val);
			if(quote) result.append('\'');
			result.append("</th>");
			return result.toString();
		}
		return null;
	}
}